# Farmix CLI

Консольная утилита для анализа и извлечения информации из 3MF файлов (Microsoft 3D Manufacturing Format). Утилита парсит 3MF архивы, извлекает данные об объектах, их размещении на печатных столах, материалах и компонентах сборок.

## Описание проекта

Farmix CLI - это инструмент командной строки, написанный на Go, который позволяет анализировать 3MF файлы и выводить структурированную информацию о:
- Объектах на печатных столах (plates)
- Материалах объектов
- Компонентах сборок (assemblies)
- Трансформациях и позиционировании

## Архитектура

### Основные компоненты:

1. **cmd/** - CLI интерфейс на базе Cobra
   - `root.go` - корневая команда с базовой конфигурацией
   - `list.go` - команда для анализа 3MF файлов
   - `crm_add_items.go` - команда для интеграции с Bitrix24 CRM
   - `crm_add_store.go` - команда для создания документов прихода на склад
   - `crm_report.go` - команда для генерации отчетов по сделкам

2. **internal/parser/** - парсинг 3MF архивов
   - `parser.go` - основная логика парсинга
   - `types.go` - структуры данных для представления 3MF модели
   - `extractor.go` - извлечение ZIP архива
   - `model_parser.go` - парсинг XML файлов модели
   - `metadata.go` - парсинг метаданных и настроек
   - `grouping.go` - группировка объектов для вывода

3. **internal/formatter/** - форматирование вывода
   - `formatter.go` - форматеры для text и CSV вывода
   - `report.go` - форматтеры для отчетов (табличный и CSV)

4. **internal/slicer/** - интеграция с OrcaSlicer
   - `slicer.go` - основная логика слайсинга STL файлов
   - `parser.go` - парсинг G-code для извлечения данных о филаменте
   - `types.go` - структуры данных для слайсинга

5. **internal/stl/** - вычисление объема STL файлов
   - `volume.go` - алгоритмы расчета объема mesh объектов
   - `types.go` - структуры для результатов и конфигурации

6. **internal/file/** - утилиты работы с файлами
   - `size.go` - функции для работы с размерами файлов

7. **internal/bitrix/** - интеграция с Bitrix24 CRM
   - `types.go` - структуры данных для API запросов/ответов
   - `client.go` - HTTP клиент для взаимодействия с Bitrix24 API
   - `deals.go` - работа со сделками и контактами
   - `catalog.go` - управление каталогом товаров
   - `store.go` - работа со складскими документами и остатками
   - `reports.go` - генерация отчетов по сделкам с кастомными полями

### Структуры данных:

**3MF парсинг:**
- `Parser3MF` - корневая структура с массивом столов
- `PlateInfo` - информация о печатном столе
- `PlateObject` - объект на столе с метаданными
- `ComponentInfo` - компонент сборки
- `Transform3D` - матрица трансформации 4x3

**Слайсинг:**
- `SliceResult` - результат слайсинга с информацией о филаменте
- `FilamentUsage` - детали расхода филамента (вес, длина, тип материала)
- `SliceConfig` - конфигурация для слайсинга
- `GCodeStats` - статистика, извлеченная из G-code файлов

**Анализ объема STL:**
- `VolumeResult` - результат вычисления объема и веса
- `VolumeConfig` - конфигурация расчета (единицы, материал, плотность)
- `BoundingBox` - ограничивающий параллелепипед модели
- `MaterialDensity` - база данных плотностей материалов

**Интеграция с Bitrix24:**
- `Deal` - информация о сделке
- `Contact` - контакт заказчика
- `Company` - компания заказчика
- `ProductSection` - папка в каталоге товаров
- `Product` - товар в каталоге
- `DealProductRow` - товар, привязанный к сделке
- `StoreDocument` - документ складского учета (приход/расход)
- `StoreDocumentElement` - позиция товара в складском документе
- `Store` - информация о складе (ID, название, статус активности)
- `DealReportRow` - строка отчета по сделке с кастомными полями
- `ReportCustomFields` - конфигурация кодов кастомных полей для отчетов

## Команды и использование

### Основные команды:

```bash
# Анализ 3MF файла с выводом в текстовом формате
./build/farmix-cli list path/to/file.3mf

# Анализ с выводом в CSV формате
./build/farmix-cli list -f csv path/to/file.3mf

# Слайсинг STL файла с помощью OrcaSlicer
./build/farmix-cli slice --orca-path /path/to/OrcaSlicer model.stl

# Слайсинг с выводом в JSON формате
./build/farmix-cli slice --orca-path /path/to/OrcaSlicer --format json model.stl

# Вычисление объема STL файла
./build/farmix-cli volume model.stl

# Вычисление объема с указанием материала и единиц
./build/farmix-cli volume --units cm3 --material PLA model.stl

# Анализ объема с размерами модели
./build/farmix-cli volume --show-bounds --format json model.stl

# Добавление STL файлов в каталог Bitrix24 и к сделке
./build/farmix-cli crm-add-items --deal-id 123 --project-name "Мой проект" --stl-dir ./models/

# Создание документа прихода на склад из товаров сделки (использует склад из конфигурации или ID 1)
./build/farmix-cli crm-add-store --deal-id 123

# Создание документа прихода с указанием склада и валюты
./build/farmix-cli crm-add-store --deal-id 123 --store-id 2 --currency USD

# Предварительный просмотр документа прихода без создания
./build/farmix-cli crm-add-store --deal-id 123 --dry-run

# Генерация отчета по активным сделкам в табличном формате
./build/farmix-cli crm-report

# Генерация отчета в CSV формате
./build/farmix-cli crm-report --format csv

# Фильтрация отчета по воронке (category ID)
./build/farmix-cli crm-report --category-id 1

# Фильтрация по нескольким воронкам
./build/farmix-cli crm-report --category-id 1,3,5

# Помощь
./build/farmix-cli --help
./build/farmix-cli list --help
./build/farmix-cli slice --help
./build/farmix-cli volume --help
./build/farmix-cli crm-add-items --help
./build/farmix-cli crm-add-store --help
./build/farmix-cli crm-report --help
```

### Команды сборки:

```bash
# Сборка проекта
make build

# Запуск тестов
make test

# Запуск тестов с подробным выводом
make test-verbose

# Запуск тестов с отчетом по покрытию
make test-coverage

# Форматирование кода
make fmt

# Проверка кода
make vet

# Очистка
make clean

# Установка зависимостей
make deps

# Быстрый запуск команды volume
make volume ARGS="model.stl"
```

## Зависимости

- Go 1.23+
- `github.com/spf13/cobra` - CLI фреймворк
- `github.com/spf13/viper` - конфигурация
- `github.com/hschendel/stl` - парсинг STL файлов
- Стандартная библиотека Go (archive/zip, encoding/xml, encoding/json)

## Конфигурация

Утилита поддерживает конфигурационный файл `~/.farmix-cli` в формате YAML:

```yaml
# URL вебхука Bitrix24 для интеграции с CRM
bitrix_webhook_url: "https://your-domain.bitrix24.ru/rest/1/your-webhook-code/"

# ID каталога товаров в Bitrix24
catalog_id: "23"

# ID склада по умолчанию для команды crm-add-store
store_id: "1"

# Настройки для команды crm-report
# Коды кастомных полей сделок для отчета
report_custom_fields:
  machine_cost: "UF_CRM_XXXXX"       # Рассчетная стоимость м/ч
  human_cost: "UF_CRM_XXXXX"         # Рассчетная стоимость ч/ч
  material_cost: "UF_CRM_XXXXX"      # Рассчетная стоимость материала
  total_cost: "UF_CRM_XXXXX"         # Итоговая стоимость изготовления
  payment_received: "UF_CRM_XXXXX"   # Оплата получена

# Статусы сделок, которые исключаются из отчета (финальные)
report_excluded_statuses: ["WON", "LOST"]
```

### Настройка Bitrix24 интеграции:

1. В Bitrix24 перейдите в раздел "Разработчикам" → "Другое" → "Входящий вебхук"
2. Создайте новый входящий вебхук с правами:
   - `crm` - для работы со сделками, контактами и компаниями
   - `catalog` - для управления каталогом товаров
3. Скопируйте URL вебхука и добавьте в конфигурационный файл
4. Получите ID каталога товаров одним из способов:
   - В разделе "Магазин" → "Каталог товаров" - URL содержит `IBLOCK_ID=XX`
   - Через API запрос: `GET /rest/catalog.catalog.list`
   - Обычно ID каталога по умолчанию: `23`
5. (Опционально) Получите ID склада по умолчанию:
   - В разделе "Магазин" → "Склады" - список складов с ID
   - Через API запрос: `GET /rest/catalog.store.list`
   - Обычно ID основного склада: `1`
6. (Для команды crm-report) Получите коды кастомных полей сделок:
   - В Bitrix24 перейдите в раздел "CRM" → "Настройки" → "Поля" → "Сделки"
   - Найдите нужные кастомные поля и скопируйте их коды (формат: `UF_CRM_XXXXXXXXXX`)
   - Добавьте коды в секцию `report_custom_fields` конфигурационного файла
   - Настройте исключаемые статусы в `report_excluded_statuses` (по умолчанию: WON, LOST)
7. Пример файла конфигурации находится в `.farmix-cli.example`

## Алгоритм работы

1. **Извлечение архива** - 3MF файл распаковывается во временную директорию `/tmp/3mf_*`
2. **Парсинг основной модели** - анализ файла `3D/3dmodel.model` для извлечения объектов и их размещения
3. **Парсинг метаданных** - анализ `Metadata/model_settings.config` для привязки объектов к столам
4. **Парсинг настроек материалов** - извлечение информации о филаментах
5. **Обработка сборок** - анализ файлов компонентов в `3D/Objects/*.model`
6. **Группировка и форматирование** - объединение одинаковых объектов и вывод результата

## Особенности реализации

**3MF анализ:**
- Поддержка простых mesh объектов и сложных сборок (assemblies)
- Каскадное применение трансформаций (компонент → сборка → размещение)
- Автоматическая очистка временных файлов
- Группировка одинаковых объектов для компактного вывода
- Обработка материалов с очисткой названий от технических суффиксов
- Валидация входных данных и информативные сообщения об ошибках

**Слайсинг STL:**
- Интеграция с OrcaSlicer через CLI интерфейс
- Парсинг G-code файлов для извлечения метаданных о филаменте
- Поддержка различных форматов вывода (text, CSV, JSON)
- Автоматический поиск созданных G-code файлов
- Обработка ошибок слайсера с информативными сообщениями
- Fallback на оценочные значения при недоступности CLI режима

**Анализ объема STL:**
- Точное вычисление объема с использованием алгоритма signed tetrahedron volumes
- Поддержка различных единиц измерения (мм³, см³, дюймы³, м³)
- База данных плотностей популярных 3D материалов
- Автоматический расчет веса на основе плотности материала
- Анализ ограничивающего параллелепипеда модели
- Валидация корректности mesh (проверка замкнутости поверхности)

**Интеграция с Bitrix24:**
- Автоматическое получение информации о сделке и заказчике
- Создание иерархической структуры каталога: Заказчик → Проект
- Массовое создание товаров на основе STL файлов
- Добавление созданных товаров к сделке с сохранением существующих
- Создание документов прихода на склад с автоматическим проведением
- Проверка статуса складского учета и информации о складах
- Обработка ошибок API с информативными сообщениями
- Поддержка конфигурации через файл ~/.farmix-cli

**Отчеты по сделкам (crm-report):**
- Получение списка активных сделок с фильтрацией по статусам и воронкам
- Отображение стандартных полей: ID, воронка (категория), название сделки, дата создания, итоговая цена сделки (OPPORTUNITY)
- Фильтрация по воронкам через флаг --category-id (можно указать одну или несколько воронок через запятую)
- Автоматическое преобразование ID воронки в название
- Поддержка кастомных полей из конфигурации
- Исключение финальных статусов (WON, LOST) из отчета
- Сортировка сделок по ID (возрастание)
- Табличный формат с выравниванием колонок и UTF-8 поддержкой
- CSV формат для экспорта данных
- Автоматическое форматирование значений (числа, даты, булевы значения)
- Автоматическое удаление суффикса валюты из денежных полей (1000|RUB → 1000)
- Информативные сообщения об ошибках конфигурации

## Тестирование

Проект включает unit-тесты для ключевых функций. Тесты покрывают:

### Тестируемые функции:

**`cmd/crm_add_items_test.go`:**
- `find3DFiles()` - поиск 3D файлов (.stl и .step)
  - Корректное нахождение файлов разного регистра
  - Игнорирование других типов файлов
  - Рекурсивный поиск в поддиректориях
  - Обработка пустых и несуществующих директорий
  - Обработка ошибок доступа к файлам

**`cmd/crm_add_store_test.go`:**
- `ValidateAddStoreParameters()` - валидация параметров команды crm-add-store
  - Проверка корректности ID сделки
  - Валидация значений по умолчанию
  - Обработка некорректных входных данных
- `StoreIDConfigLogic()` - проверка логики использования конфигурации
  - Использование склада из конфигурации при значении по умолчанию
  - Приоритет флага над конфигурацией при явном указании
  - Обработка пустых значений в конфигурации

**`internal/bitrix/deals_test.go`:**
- `ValidateDealID()` - валидация ID сделки
  - Валидация корректных числовых ID
  - Отклонение невалидных форматов
  - Обработка граничных случаев (пустые строки, спецсимволы)

**`internal/bitrix/catalog_test.go`:**
- `CreateDealProductRows()` - создание структур продуктов для API
  - Преобразование массива ID в структуры
  - Корректные значения по умолчанию
  - Обработка пустых массивов

**`internal/bitrix/store_test.go`:**
- `CheckStoreDocumentMode()` - проверка статуса складского учета
  - Обработка различных ответов API (включен/выключен)
  - Валидация структур складских документов
  - Проверка корректности создания элементов документов
  - Тестирование параметров склада и валюты
- `GetStore()` - получение информации о складе
  - Валидация ID склада
  - Проверка структуры данных склада
  - Тестирование статуса активности склада

**`cmd/crm_report_test.go`:**
- `ParseCustomFieldValue()` - парсинг значений кастомных полей
  - Обработка строковых значений
  - Преобразование числовых значений (целые и дробные)
  - Преобразование булевых значений (true → "Да", false → "Нет")
  - Обработка nil и пустых значений
  - Удаление суффикса валюты из денежных полей (1000|RUB → 1000)
- `ReportCustomFieldsValidation()` - валидация конфигурации кастомных полей
  - Проверка полной конфигурации
  - Проверка частичной конфигурации
  - Обработка пустой конфигурации
- `FormatValidation()` - валидация формата вывода
  - Проверка поддерживаемых форматов (text, csv)
  - Отклонение неподдерживаемых форматов

### Команды тестирования:
```bash
# Быстрый запуск всех тестов
make test

# Подробный вывод с именами тестов
make test-verbose  

# Отчет по покрытию кода
make test-coverage
```

## Ограничения

**OrcaSlicer CLI режим:**
- OrcaSlicer имеет ограничения в CLI режиме без GUI
- Некоторые профили могут быть несовместимы в headless режиме  
- Для лучших результатов рекомендуется использовать 3MF файлы вместо STL
- При ошибках слайсинга показываются оценочные значения на основе размера модели

**Анализ объема STL:**
- Алгоритм работает корректно только для замкнутых (manifold) mesh объектов
- Сломанные или незамкнутые модели могут давать неточные результаты
- Требуется правильная ориентация нормалей треугольников (right-hand rule)
- Пересекающиеся треугольники могут влиять на точность расчетов

## Примеры файлов

Проект включает тестовые файлы в директории `samples/`:
- `22d.3mf` - простая 3MF модель с несколькими объектами
- `8+2+12.3mf` - 3MF модель с различными типами объектов
- `opengrid-9x9.3mf` - сложная 3MF модель с множеством объектов
- `test_cube.stl` - простой тестовый куб 10x10x10мм для проверки объема

## Настройки разработки

- `mise.toml` - конфигурация для mise (version manager)
- `go.mod` - зависимости Go модуля
- `Makefile` - автоматизация сборки и развертывания