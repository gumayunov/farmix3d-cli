# Настройка складского учета в Bitrix24

## Обязательные шаги для работы команды crm-add-store

### 1. Настройка прав доступа вебхука

1. Войдите в Bitrix24 как администратор
2. Перейдите в **Разработчикам** → **Другое** → **Входящий вебхук**
3. Найдите ваш вебхук или создайте новый
4. Нажмите **"Изменить"** для существующего вебхука
5. Убедитесь, что включены следующие права доступа:
   - ✅ **catalog** (Торговый каталог) - **ОБЯЗАТЕЛЬНО!**
   - ✅ **crm** (CRM)
6. Сохраните изменения

### 2. Активация складского учета

1. Перейдите в **Настройки** → **Настройки модулей** → **Торговый каталог**
2. Включите опции:
   - ✅ **"Складской учет"**
   - ✅ **"Документооборот складов"**
3. Сохраните настройки

### 3. Создание складов

1. Перейдите в **Магазин** → **Склады**
2. Нажмите **"Добавить склад"**
3. Заполните обязательные поля:
   - **Название склада** (например, "Основной склад")
   - **Код склада** (например, "main")
4. Убедитесь, что склад активен (статус **"Да"**)
5. Сохраните склад
6. Запомните **ID склада** - он потребуется для команды

### 4. Настройка каталога товаров

1. Перейдите в **Магазин** → **Каталог товаров**
2. Убедитесь, что каталог создан и активен
3. Запомните **ID каталога** (обычно видно в URL как `IBLOCK_ID=XX`)
4. Добавьте ID каталога в файл `~/.farmix-cli`:
   ```yaml
   catalog_id: "23"  # замените на ваш ID
   ```

### 5. Конфигурация утилиты

Создайте или отредактируйте файл `~/.farmix-cli`:

```yaml
# URL вебхука Bitrix24
bitrix_webhook_url: "https://your-domain.bitrix24.ru/rest/1/your-webhook-code/"

# ID каталога товаров
catalog_id: "23"

# ID склада по умолчанию (можно переопределить через --store-id)
store_id: "1"
```

### 6. Проверка настройки

Запустите команду для проверки:

```bash
./build/farmix-cli crm-add-store --deal-id 123 --dry-run
```

Если все настроено правильно, вы увидите:
- ✅ Складской учет включен
- ✅ Найдено X складов
- ✅ Склад: Название склада (ID: 1)

### Типичные ошибки и решения

#### "Список складов пуст"
- Проверьте права доступа вебхука (пункт 1)
- Убедитесь, что складской учет включен (пункт 2)
- Создайте хотя бы один склад (пункт 3)

#### "Склад ID X не найден"
- Проверьте, что склад с указанным ID существует
- Убедитесь, что склад активен
- Используйте команду без `--store-id` чтобы увидеть список доступных складов

#### "Складской учет не включен"
- Выполните пункт 2 настройки

#### "Нет доступа к API складов"
- Проверьте права доступа вебхука (пункт 1)
- Убедитесь, что включены права **catalog**

### Получение ID склада

Если вы не знаете ID склада:

1. Запустите команду с несуществующим ID:
   ```bash
   ./build/farmix-cli crm-add-store --deal-id 123 --store-id 999 --dry-run
   ```
2. В выводе ошибки вы увидите список всех доступных складов с их ID

### API методы, которые должны работать

После правильной настройки должны работать следующие Bitrix24 API методы:
- `catalog.document.mode.status` - проверка складского учета
- `catalog.store.list` - список складов
- `catalog.store.get` - информация о складе
- `catalog.document.add` - создание документа
- `catalog.document.element.add` - добавление товаров
- `catalog.document.confirm` - проведение документа