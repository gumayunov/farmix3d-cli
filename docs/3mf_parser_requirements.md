# ТЗ: Парсер 3MF файлов для извлечения информации об объектах на столах

## Общее описание

Необходимо консольную утилиту для извлечения информации о размещении объектов на столах (plates) из 3MF файлов, с поддержкой обработки сборок (assemblies).

Форматы вывода: csv, text для чтения из консоли

Обработка ошибок - сообщение в STDERR и завершение работы

Нужно поддерживать последнюю версию 3mf, без необходимости в обратной совместимости

В качестве временной директории нужно создавать новую в /tmp/

Дополнительных команд не нужно.

## Примеры использования

- farmix-cli list path/to/file.3mf

## Входные данные

- Путь к 3MF файлу (ZIP архив)

## Внутренние данные

Структура данных, содержащая список объектов для каждого стола с детальной информацией о составе объектов.

### 1. Структуры данных

```go
type PlateObject struct {
    ID           int                `json:"id"`
    Name         string             `json:"name"`
    Type         string             `json:"type"` // "mesh", "assembly"
    Position     Transform3D        `json:"position"`
    Printable    bool              `json:"printable"`
    Components   []ComponentInfo   `json:"components,omitempty"` // для assembly
}

type ComponentInfo struct {
    ID           int         `json:"id"`
    Name         string      `json:"name"`
    SourceFile   string      `json:"source_file"`
    Transform    Transform3D `json:"transform"`
}

type Transform3D struct {
    Matrix [12]float64 `json:"matrix"` // 4x3 матрица трансформации
}

type PlateInfo struct {
    PlateID   int           `json:"plate_id"`
    PlateName string        `json:"plate_name"`
    Objects   []PlateObject `json:"objects"`
}

type Parser3MF struct {
    Plates []PlateInfo `json:"plates"`
}
```

## Алгоритм обработки

### Этап 1: Распаковка 3MF архива

1. Распаковать ZIP архив во временную директорию
2. Найти основные файлы:
   - `3D/3dmodel.model` - основной XML с объектами и размещением
   - `Metadata/model_settings.config` - привязка объектов к столам
   - `3D/Objects/*.model` - отдельные файлы сборок (если есть)

### Этап 2: Парсинг основного XML файла (`3D/3dmodel.model`)

1. **Секция `<resources>`**: Извлечь информацию об объектах
   - Простые объекты: `<object type="model"><mesh>...</mesh></object>`
   - Сборки: `<object type="model"><components>...</components></object>`
   
2. **Секция `<build>`**: Извлечь размещение объектов
   - Для каждого `<item>` получить:
     - `objectid` - ID объекта
     - `transform` - матрица трансформации 4x3
     - `printable` - флаг печатаемости

### Этап 3: Парсинг привязки к столам (`Metadata/model_settings.config`)

1. **Секции `<plate>`**: Для каждого стола получить:
   - `plater_id` - ID стола
   - `plater_name` - имя стола
   
2. **Секции `<model_instance>`**: Привязка объектов к столам:
   - `object_id` - ID объекта из основного XML
   - `instance_id` - ID экземпляра
   - `identify_id` - внутренний ID

3. **Секции `<object>` и `<part>`**: Метаданные объектов:
   - Имена частей
   - Исходные файлы
   - Дополнительные трансформации

### Этап 4: Обработка сборок

1. Для объектов типа assembly (`<components>`):
   - Извлечь список компонентов из `<component>` элементов
   - Для каждого компонента получить:
     - `p:path` - путь к файлу сборки
     - `objectid` - ID компонента в файле сборки  
     - `transform` - трансформация компонента

2. Загрузить файлы сборок (`3D/Objects/*.model`):
   - Парсить структуру объектов в файле сборки
   - Сопоставить с метаданными из `model_settings.config`

## Особые случаи обработки

### 1. Простые объекты на столах
- Объект напрямую содержит mesh
- Размещается на столе без сборки

### 2. Сборки на столах  
- Объект содержит `<components>` 
- Каждый компонент ссылается на отдельный файл
- Трансформации применяются каскадно: компонент → сборка → размещение на столе

### 3. Пустые сборки
- Файл сборки может содержать пустую секцию `<resources/>`
- Такие сборки следует игнорировать

## Требования к реализации

### Зависимости
- Стандартная библиотека Go
- XML парсер (`encoding/xml`)
- ZIP обработка (`archive/zip`)
- JSON для сериализации (`encoding/json`)

### Обработка ошибок
- Валидация структуры 3MF файла
- Проверка существования требуемых файлов
- Обработка поврежденных XML
- Информативные сообщения об ошибках

### Тестирование
- Unit тесты для каждого компонента
- Интеграционные тесты с реальными 3MF файлами
- Тесты граничных случаев (пустые сборки, отсутствующие файлы)

